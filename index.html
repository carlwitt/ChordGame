<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chord Game</title>

<link href="style.css" rel="stylesheet">

<script type="text/javascript" src="music-theory.js"></script>
<script type="text/javascript" src="recognition-task.js"></script>

</head>
<body>
	<div id="settings">
		Tonarten mit bis zu <span id="label_maxAccidentals"></span> Vorzeichen <input type="range" id="input_maxAccidentals" min="0" max="6" value="5" /> 
		Sprache <select id="input_language"><option>german</option><option>english</option></select>
	</div>
	<div id="stats">
		Richtig: <span id="correctAnswers"></span>/<span id="totalAnswers"></span> = <span id="percentageCorrectAnswers"></span>%<!-- <br/> -->
		<input type="button" value="Reset" onclick="if(confirm('Reset?')) resetStats()"/>
	</div>

	<svg xmlns="&ns_svg;" xmlns:xlink="&ns_xlink;" xmlns:a="http://ns.adobe.com/AdobeSVGViewerExtensions/3.0/"
	 width="100%" height="400" viewBox="-2 -2 1400 480" xml:space="preserve">
		<defs>
		</defs>
		<g>
			<!-- white keys -->
			<rect class="white key C" x="2.0"/>
			<rect class="white key D" x="101.8823242"/>
			<rect class="white key E" x="201.7651367"/>
			<rect class="white key F" x="301.6445313"/>
			<rect class="white key G" x="401.5273438"/>
			<rect class="white key A" x="501.6308594"/>
			<rect class="white key B" x="601.5078125"/>

			<rect class="white key C" x="701.3896484"/>
			<rect class="white key D" x="801.2675781"/>
			<rect class="white key E" x="901.1503906"/>
			<rect class="white key F" x="1001.0292969"/>
			<rect class="white key G" x="1100.9121094"/>
			<rect class="white key A" x="1201.015625"/>
			<rect class="white key B" x="1300.8925781"/>

			<!-- black keys (need to be declared after the white keys to render them above the white keys) 
				 They have their notes annotated to add a css class for each accidental,
				 e.g., note=D ==> add D# and Eb as CSS classes -->
			<rect class="black key" note="C" x="70.7202148"/>
			<rect class="black key" note="D" x="171.2246094"/>
			<rect class="black key" note="F" x="370.5078125"/>
			<rect class="black key" note="G" x="470.6118164"/>
			<rect class="black key" note="A" x="570.4882813"/>

			<rect class="black key" note="C" x="770.0351563"/> 
			<rect class="black key" note="D" x="870.5351563"/> 
			<rect class="black key" note="F" x="1069.8183594"/> 
			<rect class="black key" note="G" x="1169.9228516"/> 
			<rect class="black key" note="A" x="1269.7988281"/> 
		</g>
	</svg>
	<input type="button" value="Nächster Akkord" id="nextTask" onclick="nextChord()" />
	<!-- <div id="solution"></div> -->
	<table id="solution-options" style="width:100%; margin-top: 16px; font-weight: bold; font-size: large;">
		<!-- <tr>
			<td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td>
		</tr>
		<tr>
			<td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td>
		</tr> -->
		<tr>
			<td>6♭</td><td>5♭</td><td>4♭</td><td>3♭</td><td>2♭</td><td>♭</td><td></td><td>♯</td><td>2♯</td><td>3♯</td><td>4♯</td><td>5♯</td><td>6♯</td>
		</tr>
		<tr class="solution option major">
			<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
		</tr>
		<tr class="solution option minor">
			<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
		</tr>
		<!-- <tr>
			<td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td><td>1.</td>
		</tr>
		<tr>
			<td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td><td>2.</td>
		</tr> -->

	</table>
	<table id="solution-options-inversion">
		<tr><td class="base"></td><td class="first"></td><td class="second"></td></tr>
	</table>


	<script type="text/javascript">
		// wire options control elements to state variables

		// number of accidentals
		const accidentalsInput = document.getElementById('input_maxAccidentals');
		accidentalsInput.value = state.maxAccidentals;
		accidentalsInput.onchange = function(){
			state.maxAccidentals = this.value;
			document.getElementById('label_maxAccidentals').innerText = state.maxAccidentals;
			persistState();
		};
		accidentalsInput.onchange();

		// language select
		const languageInput = document.getElementById('input_language');
		for(i=0; i<languageInput.options.length; i++){
			if(languageInput.options[i].innerText == state.language) languageInput.selectedIndex = i;
		}
		document.getElementById('input_language').onchange = function(){
			state.language = this.value;
			persistState();
			window.location.reload();
		};
	
		// add classes the piano keys that state their note name(s)
		// get the SVG elements that represent the piano keys
		var keyElements = Array.from(document.getElementsByClassName('key'));
		// sort the keys by horizontal position, such that we get C, C#, D, D#, etc.
		keyElements.sort((r1,r2)=>r1.attributes.x.value - r2.attributes.x.value)

		// add css classes to black keys that use SHARP_SYMBOL and FLAT_SYMBOL
		Array.from(document.getElementsByClassName('black key')).forEach(rect => {
			baseNote = rect.attributes.note.value;
			sharp = baseNote + SHARP_SYMBOL;
			flat = enharmonicEquivalent(sharp);
			rect.classList.add(sharp, flat);
		});

		// list all major/minor chords as solution options in order of the circle of fifths
		for(const mode of modes){
			const options = document.querySelectorAll(`.solution.option.${mode} td`);
			options.forEach(function(element, i){
				// fill the table cell with the chord's base note name
				const key = i;
				const baseNote = applyAccidental(key, keys[mode].baseNote[key]);
				const keyName = NAMING[state.language].baseNote(baseNote, mode);
				
				// solution data
				element.key = key;
				element.mode = mode;

				element.innerText = keyName;
				element.onclick = proposeKeyAndMode;
			})
		}

		// inversion 
		document.querySelectorAll("#solution-options-inversion td").forEach(function(element, i){
			element.inversion = i;

			element.innerText = NAMING[state.language].inversion[i];
			element.onclick = proposeInversion;
		})	

		// generate first chord
		nextChord();
		refreshStats();
	</script>


</body>